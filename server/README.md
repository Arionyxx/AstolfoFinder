# Backend - Express.js Server

A Node.js backend built with Express, TypeScript, and Prisma ORM.

## ğŸ“‹ Setup

### Install Dependencies

From the root directory:
```bash
yarn install
```

### Environment Configuration

1. Copy the example environment file:
```bash
cp .env.example .env
```

2. Update `.env` with your configuration:
```env
PORT=5000
NODE_ENV=development
DATABASE_URL=postgresql://user:password@localhost:5432/monorepo_db
CORS_ORIGIN=http://localhost:5173
```

### Database Setup

**Note**: For development without PostgreSQL, you can temporarily switch to SQLite by changing the `provider` in `prisma/schema.prisma` to `"sqlite"` and using `DATABASE_URL="file:./dev.db"` in your `.env` file.

1. Create PostgreSQL database:
```bash
createdb monorepo_db
```

2. Generate Prisma Client:
```bash
yarn prisma:generate
```

3. Run initial migration:
```bash
yarn migrate --name init
```

4. Seed the database with default hobbies:
```bash
yarn db:seed
```

### Migration Commands

Create a new migration:
```bash
yarn migrate --name <migration-name>
```

Deploy migrations to production:
```bash
yarn migrate:deploy
```

Reset database and re-run all migrations:
```bash
yarn migrate:reset
```

### Database Schema

The application includes the following data models:

- **User**: Authentication credentials, email verification, password reset
- **Profile**: User profile information (display name, age, gender, bio, location)
- **Hobby**: Lookup table for hobbies and interests (pre-seeded)
- **ProfileHobby**: Join table connecting profiles to hobbies
- **Swipe**: User swipe actions (like/pass) with timestamps
- **Match**: Match records between two users
- **ProfilePhoto**: User profile photos with primary flag

### Seeding

The database is automatically seeded with 60+ default hobbies across categories:
- Sports & Fitness
- Arts & Culture  
- Food & Drink
- Travel & Adventure
- Technology & Gaming
- Lifestyle & Social
- Intellectual & Educational
- Wellness & Spirituality

To re-seed the database:
```bash
yarn db:seed
```

## ğŸš€ Development

Start the development server with auto-reload:
```bash
yarn dev
```

The server will start at `http://localhost:5000`

## ğŸ”¨ Available Scripts

- `yarn dev` - Start development server with ts-node-dev
- `yarn build` - Build TypeScript to JavaScript
- `yarn start` - Run the built application
- `yarn lint` - Check code with ESLint
- `yarn lint:fix` - Fix linting issues
- `yarn type-check` - Run TypeScript compiler
- `yarn test` - Run unit and integration tests
- `yarn test:ui` - Run tests with UI
- `yarn migrate` - Run Prisma migrations interactively
- `yarn migrate:deploy` - Deploy pending migrations (production)
- `yarn migrate:reset` - Reset database and re-run migrations
- `yarn prisma:generate` - Generate Prisma Client
- `yarn db:seed` - Seed database with default data

## ğŸ“ Project Structure

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # Express server entry point
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ prisma.ts           # Prisma client utility
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth.service.ts     # Authentication business logic
â”‚   â”‚   â””â”€â”€ auth.service.test.ts# Auth service tests
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.routes.ts      # Authentication endpoints
â”‚   â”‚   â””â”€â”€ auth.routes.test.ts # Auth routes tests
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.middleware.ts  # Auth middleware (extractUser, requireAuth)
â”‚   â””â”€â”€ schemas/
â”‚       â””â”€â”€ auth.ts             # Zod validation schemas
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma           # Database schema
â”‚   â”œâ”€â”€ seed.ts                 # Database seeding script
â”‚   â””â”€â”€ migrations/             # Database migrations (auto-generated)
â”œâ”€â”€ dist/                       # Compiled JavaScript (generated by build)
â”œâ”€â”€ .env.example                # Environment variables template
â”œâ”€â”€ tsconfig.json               # TypeScript configuration
â”œâ”€â”€ .eslintrc.json              # ESLint configuration
â”œâ”€â”€ .prettierrc.json            # Prettier configuration
â”œâ”€â”€ vitest.config.ts            # Vitest configuration
â””â”€â”€ package.json                # Dependencies and scripts
```

## ğŸ—„ï¸ Database

### Prisma Schema

The database schema is defined in `prisma/schema.prisma` and includes:

**Core Models:**
- **User**: Authentication and user management
- **Profile**: Extended user information and preferences
- **Hobby**: Pre-defined hobbies and interests
- **ProfileHobby**: Many-to-many relationship between profiles and hobbies
- **Swipe**: User swipe actions (like/pass) with timestamps
- **Match**: Match records between users
- **ProfilePhoto**: User profile photos

**Key Features:**
- Email verification and password reset tokens
- Location-based matching with radius preferences
- Timestamped swipe actions with date-only field for querying
- Unique constraints to prevent duplicate swipes and matches
- Cascade deletes for data integrity

Example schema structure:
```prisma
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  emailVerified     Boolean   @default(false)
  // ... additional fields
  profile           Profile?
  swipesAsActor     Swipe[]
  swipesAsTarget    Swipe[]
  matchesAsUser1    Match[]
  matchesAsUser2    Match[]
}

model Profile {
  id          String    @id @default(cuid())
  userId      String    @unique
  displayName String?
  age         Int?
  gender      String?
  locationLat Float?
  locationLng Float?
  radiusPref  Int?      @default(25)
  // ... additional fields
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  hobbies     ProfileHobby[]
  photos      ProfilePhoto[]
}
```

### Running Migrations

Create a new migration:
```bash
yarn migrate --name <migration-name>
```

Deploy migrations to production:
```bash
yarn migrate:deploy
```

Reset database and re-run all migrations:
```bash
yarn migrate:reset
```

### Prisma Studio (GUI)

View and edit your database:
```bash
yarn prisma studio
```

## ğŸ”Œ API Endpoints

### Health Check
- `GET /health` - Server health status

### Authentication Endpoints

All authentication endpoints return HTTP-only cookies for security and follow RESTful conventions.

#### 1. Register New User
```
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePassword123"
}
```

**Request Validation:**
- `email` - Valid email address format (required)
- `password` - Minimum 8 characters, must contain uppercase, lowercase, and number (required)

**Success Response (201):**
```json
{
  "message": "User registered successfully",
  "user": {
    "id": "cuid123",
    "email": "user@example.com"
  }
}
```

**Cookies Set:**
- `accessToken` - JWT token (expires in 15 minutes, HTTP-only, secure, sameSite strict)
- `refreshToken` - JWT refresh token (expires in 7 days, HTTP-only, secure, sameSite strict)

**Error Responses:**
- `400` - Invalid input (validation failed)
- `409` - User with this email already exists

#### 2. User Login
```
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePassword123"
}
```

**Request Validation:**
- `email` - Valid email address format (required)
- `password` - Any string (required)

**Success Response (200):**
```json
{
  "message": "Login successful",
  "user": {
    "id": "cuid123",
    "email": "user@example.com"
  }
}
```

**Cookies Set:**
- `accessToken` - JWT token (expires in 15 minutes, HTTP-only, secure, sameSite strict)
- `refreshToken` - JWT refresh token (expires in 7 days, HTTP-only, secure, sameSite strict)

**Error Responses:**
- `400` - Invalid input (validation failed)
- `401` - Invalid email or password

#### 3. Refresh Access Token
```
POST /api/auth/refresh
```

This endpoint uses the `refreshToken` cookie automatically. No request body needed.

**Success Response (200):**
```json
{
  "message": "Tokens refreshed successfully",
  "user": {
    "id": "cuid123",
    "email": "user@example.com"
  }
}
```

**Cookies Set:**
- `accessToken` - New JWT token (expires in 15 minutes)
- `refreshToken` - New JWT refresh token (expires in 7 days)

**Error Responses:**
- `401` - Refresh token not found or invalid

#### 4. User Logout
```
POST /api/auth/logout
```

Requires authentication (valid accessToken cookie).

**Success Response (200):**
```json
{
  "message": "Logout successful"
}
```

**Cookies Cleared:**
- `accessToken` - Cleared
- `refreshToken` - Cleared

**Error Responses:**
- `401` - Unauthorized (not authenticated)

#### 5. Get Current User Info
```
GET /api/auth/me
```

Requires authentication (valid accessToken cookie).

**Success Response (200):**
```json
{
  "user": {
    "userId": "cuid123",
    "email": "user@example.com"
  }
}
```

**Error Responses:**
- `401` - Unauthorized (not authenticated)

### Protected Routes

To protect a route, use the `requireAuth` middleware:

```typescript
import { requireAuth } from './middleware/auth.middleware.js';

router.get('/protected-endpoint', requireAuth, (req: Request, res: Response) => {
  // req.user contains: { userId: string, email: string }
  const { userId, email } = req.user!;
  // Route handler logic here
});
```

### Authentication Flow

1. **Registration**: User registers with email/password â†’ Receives accessToken and refreshToken cookies
2. **Login**: User logs in with credentials â†’ Receives accessToken and refreshToken cookies
3. **Authenticated Request**: Client automatically sends cookies with each request â†’ Middleware extracts user
4. **Token Expiry**: When accessToken expires (15 min) â†’ Client calls `/api/auth/refresh` with refreshToken
5. **Logout**: User logs out â†’ Cookies are cleared

### Authentication Middleware

The auth system includes two key middleware functions:

**`extractUser`** - Automatically extracts user from accessToken cookie on every request:
```typescript
app.use(extractUser);
```

**`requireAuth`** - Guards routes and requires authentication:
```typescript
router.post('/protected', requireAuth, handler);
```

If authentication fails, returns `401 Unauthorized` with error message.

### Environment Variables for Auth

Add these to your `.env` file:
```env
JWT_SECRET=your-secret-key-change-in-production
JWT_REFRESH_SECRET=your-refresh-secret-key-change-in-production
ACCESS_TOKEN_EXPIRY=15m
REFRESH_TOKEN_EXPIRY=7d
```

**âš ï¸ Production Notes:**
- Change JWT secrets to secure random strings (use `openssl rand -base64 32`)
- Use strong, randomly generated secrets
- Never commit secrets to version control
- Use environment-specific values

### Testing Auth

Run auth tests:
```bash
yarn test
```

The test suite includes:
- Password hashing and comparison
- Token generation and verification
- User registration and duplicate checking
- Login with valid/invalid credentials
- Token refresh flows
- Route-level authentication

### Error Handling

All auth endpoints return appropriate HTTP status codes:
- `201` - Created (successful registration)
- `200` - OK (successful login, refresh, logout, get user)
- `400` - Bad Request (validation failed)
- `401` - Unauthorized (invalid credentials, no token, expired token)
- `409` - Conflict (user already exists)

## ğŸ“ Code Style

- **Linting**: ESLint with TypeScript support
- **Formatting**: Prettier
- **Pre-commit**: Husky hooks run lint and format on commit

Run linting:
```bash
yarn lint
```

Auto-fix linting issues:
```bash
yarn lint:fix
```

## ğŸ”’ Security Notes

- Keep `.env` file out of version control (already in .gitignore)
- Use environment variables for all secrets
- Configure CORS_ORIGIN appropriately
- Validate and sanitize all user input
- Use HTTPS in production

## ğŸ“¦ Adding Dependencies

```bash
yarn workspace @monorepo/server add <package-name>
# or from server directory:
yarn add <package-name>
```

Add as dev dependency:
```bash
yarn workspace @monorepo/server add -D <package-name>
```

## ğŸš¢ Deployment

1. Build the project:
```bash
yarn build
```

2. Set environment variables on the server:
```bash
export DATABASE_URL=postgresql://...
export PORT=5000
export NODE_ENV=production
```

3. Run the server:
```bash
yarn start
```

Or use a process manager like PM2:
```bash
pm2 start dist/index.js --name "api-server"
```

## ğŸ“š Resources

- [Express.js Guide](https://expressjs.com/en/starter/basic-routing.html)
- [Prisma ORM](https://www.prisma.io/docs/)
- [PostgreSQL](https://www.postgresql.org/docs/)
- [TypeScript](https://www.typescriptlang.org/docs/)
